#!/bin/bash

# Parse flags
INCLUDE_GIT=true
while [[ $# -gt 0 ]]; do
  case "$1" in
    --no-git)
      INCLUDE_GIT=false
      shift
      ;;
    *)
      break
      ;;
  esac
done

SRC="$1"
DEST="$2"

if [[ -z "$SRC" || -z "$DEST" ]]; then
  echo "Usage: cpr [--no-git] <source> <destination>"
  echo "  --no-git: Exclude .git directory from copy (default: includes .git)"
  exit 1
fi

SRC=$(cd "$SRC" && pwd)
DEST=$(mkdir -p "$DEST" && cd "$DEST" && pwd)

cd "$SRC" || exit 1

# Copy tracked and untracked files (respecting .gitignore)
git ls-files --cached --others --exclude-standard -z | \
    xargs -0 -P 8 -I{} bash -c 'file="$1"; dest="$2"; if [[ -f "$file" ]]; then mkdir -p "$dest/$(dirname "$file")"; cp -p "$file" "$dest/$file"; fi' _ {} "$DEST"

# Handle .git directory/file if not excluded
if [[ "$INCLUDE_GIT" == "true" ]]; then
  if [[ -f ".git" ]]; then
    # This is a worktree - .git is a file pointing to the main repo
    GITDIR_LINE=$(cat .git)
    # Extract the path from "gitdir: /path/to/main/.git/worktrees/name"
    WORKTREE_GITDIR="${GITDIR_LINE#gitdir: }"

    # Navigate up to find the main .git directory
    # From /path/to/main/.git/worktrees/name -> /path/to/main/.git
    MAIN_GITDIR=$(dirname $(dirname "$WORKTREE_GITDIR"))

    if [[ -d "$MAIN_GITDIR" ]]; then
      # Copy the main .git directory
      cp -rp "$MAIN_GITDIR" "$DEST/.git"
      echo "Copied from $SRC to $DEST (including .git from worktree root: $MAIN_GITDIR) using parallel mode, respecting .gitignore rules."
    else
      echo "Warning: Could not find main .git directory at $MAIN_GITDIR"
      echo "Copied from $SRC to $DEST (excluding .git - main repo not found) using parallel mode, respecting .gitignore rules."
    fi
  elif [[ -d ".git" ]]; then
    # Regular repository - .git is a directory
    cp -rp .git "$DEST/.git"
    echo "Copied from $SRC to $DEST (including .git) using parallel mode, respecting .gitignore rules."
  else
    echo "Copied from $SRC to $DEST (no .git found) using parallel mode, respecting .gitignore rules."
  fi
else
  echo "Copied from $SRC to $DEST (excluding .git) using parallel mode, respecting .gitignore rules."
fi
